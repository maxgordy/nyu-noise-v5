---
title: "maxa3v3"
output: html_document
date: "2024-12-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(janitor)
library(formattable)
library(sf)
library(ggplot2)
library(tidygeocoder)
library(ggmap)
register_google(key = "AIzaSyDWgdNlNOOYlsUXRW_7Fe3FpdcZeTYIxrE")

```


```{r read calls}
#import csv cleaned for NYU and CU zip codes
calls <- read.csv("311_Noise_Complaints.csv")
# Convert "Created.Date" to Date format and extract the year
calls <- calls %>%
  mutate(Created.Date = as.Date(Created.Date, format = "%m/%d/%Y"),
         Year = as.numeric(format(Created.Date, "%Y")))

# Specify the noise complaint types to keep
descriptors_to_keep <- c(
  "Banging/Pounding", "Loud Music/Party", "Loud Talking", "Loud Television",
  "Noise: Alarms", "Noise: Construction Before/After Hours (NM1)",
  "Noise: Construction Equipment (NC1)", "Noise: Jack Hammering (NC2)",
  "Noise: Loud Music/Daytime (Mark Date and Time) (NN1)",
  "Noise: Loud Music/Nighttime(Mark Date and Time) (NP1)",
  "People Created Noise"
)
```

```{r clean calls}
#Filter the dataset by the complaint types
calls_filtered <- calls %>%
  filter(Descriptor %in% descriptors_to_keep) %>%
  filter(!is.na(Latitude) & !is.na(Longitude)) %>%  #count NAs
  clean_names()

#convert to sf
calls_sf <- st_as_sf(calls_filtered, coords = c("longitude", "latitude"), crs = 2263)

```

```{r Houston and Broadway buffer}

# Define your point as an sf object
point <- st_as_sf(data.frame(id = 1, 
                             lon = -73.9994136, 
                             lat = 40.7253766), 
                  coords = c("lon", "lat"), crs = 2263)

point_proj <- st_transform(point, 2263)

buffer <- st_buffer(point_proj, dist = .01) #distance in degrees

data_within_buffer <- calls_sf[st_within(calls_sf, buffer, sparse = FALSE), ]

```

```{r heatmap}

# allcallsmap <- ggplot() +
#   geom_sf(data = calls_sf, aes(color = "311 Calls"), alpha = 0.5, size = 0.5) +
#   scale_color_manual(values = "red") +
#   theme_minimal() +
#   labs(title = "311 Calls Heatmap (Transparency Effect)",
#        color = NULL)
# 
# print(allcallsmap)

heatmap <- ggplot() +
  geom_sf(data = buffer, fill = NA, color = "blue") +  # Buffer boundary
  geom_sf(data = data_within_buffer, aes(color = "311 Calls"), alpha = 0.5, size = 0.5) +
  scale_color_manual(values = "red") +
  theme_minimal() +
  labs(title = "311 Calls Heatmap (Transparency Effect)",
       subtitle = "Within buffer",
       color = NULL)

print(heatmap)

```

```{r property map}
#list of NYU buildings within neighborhood plan
addresses <- data.frame(
  address = c(
    "35 West 4th Street, New York, NY",
    "726 Broadway, New York, NY",
    "708 Broadway, New York, NY",
    "404 Lafayette, New York, NY",
    "14 E 4th Street, New York, NY",
    "383 Lafayette Street, New York, NY",
    "411 Lafayette Street, New York, NY",
    "20 Cooper Square, New York, NY"
  )
)

# Convert to sf object (EPSG:4326 by default)
coordinates <- addresses %>%
  mutate_geocode(address, method = "google", lat = "latitude", long = "longitude")

# Step 3: Convert to sf object in EPSG:4326 (default from geocode)
properties_sf <- st_as_sf(coordinates, coords = c("longitude", "latitude"), crs = 4326)

# Step 4: Transform to EPSG:2263
properties_sf_2263 <- st_transform(properties_sf, crs = 2263)

# Check CRS
st_crs(properties_sf_2263)  # Should now be EPSG:2263

```


```{r properties with buffer}

heatmap <- ggplot() +
  geom_sf(data = properties_sf_2263, color = "purple") +# properties
  geom_sf(data = buffer, fill = NA, color = "blue") +  # Buffer boundary
  geom_sf(data = data_within_buffer, aes(color = "311 Calls"), alpha = 0.5, size = 0.5) +
  scale_color_manual(values = "red") +
  theme_minimal() +
  labs(title = "311 Calls Heatmap (Transparency Effect)",
       subtitle = "Within buffer",
       color = NULL)
  
print(heatmap)

```



