---
title: "maxa3v3"
output: html_document
date: "2024-12-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(janitor)
library(formattable)
library(sf)
library(ggplot2)
library(tmap)

```


```{r read calls}
#import csv cleaned for NYU and CU zip codes
calls <- read.csv("311_Noise_Complaints.csv")
# Convert "Created.Date" to Date format and extract the year
calls <- calls %>%
  mutate(Created.Date = as.Date(Created.Date, format = "%m/%d/%Y"),
         Year = as.numeric(format(Created.Date, "%Y")))

# Specify the noise complaint types to keep
descriptors_to_keep <- c(
  "Banging/Pounding", "Loud Music/Party", "Loud Talking", "Loud Television",
  "Noise: Alarms", "Noise: Construction Before/After Hours (NM1)",
  "Noise: Construction Equipment (NC1)", "Noise: Jack Hammering (NC2)",
  "Noise: Loud Music/Daytime (Mark Date and Time) (NN1)",
  "Noise: Loud Music/Nighttime(Mark Date and Time) (NP1)",
  "People Created Noise"
)
```

```{r clean calls}
#Filter the dataset by the complaint types
calls_filtered <- calls %>%
  filter(Descriptor %in% descriptors_to_keep) %>%
  filter(!is.na(Latitude) & !is.na(Longitude)) %>%  #count NAs
  clean_names()

#convert to sf
calls_sf <- st_as_sf(calls_filtered, coords = c("longitude", "latitude"), remove = FALSE, crs = 4326)

```

```{r Wash Sq Park buffer}
#COMMENTING THIS OUT BC WE ARE NON LONGER USING THIS BUFFER and also it doesn't work lol

# Define your point as an sf object
point <- st_as_sf(data.frame(id = 1,
                             lon = -73.9999069,
                             lat = 40.7308878),
                  coords = c("lon", "lat"), crs = 4326)
                  

point_proj <- st_transform(point, crs = 4326)

buffer <- st_buffer(point_proj, dist = 1200)

st_crs(calls_sf) == st_crs(buffer) #test crs

plot(st_geometry(buffer), col = "white", border = "blue")  # Plot buffer
plot(st_geometry(calls_sf), add = TRUE, col = "red")      # Add calls points

# Filter calls_sf points that are within the buffer
data_within_buffer <- calls_sf %>%
  filter(st_within(geometry, buffer, sparse = FALSE) %>% rowSums() > 0)

# #MAPPING

# allcallsmap <- ggplot() +
#   geom_sf(data = calls_sf, aes(color = "311 Calls"), alpha = 0.5, size = 0.5) +
#   scale_color_manual(values = "red") +
#   theme_minimal() +
#   labs(title = "311 Calls Heatmap (Transparency Effect)",
#        color = NULL)
#
# print(allcallsmap)

heatmap <- ggplot() +
  geom_sf(data = buffer, fill = NA, color = "blue") +  # Buffer boundary
  geom_sf(data = data_within_buffer, aes(color = "311 Calls"), alpha = 0.5, size = 0.5) +
  scale_color_manual(values = "red") +
  theme_void() +
  labs(title = "311 Noise Calls Heatmap (Transparency Effect)",
       subtitle = "Within 1200m buffer",
       color = NULL)

print(heatmap)
```

```{r justfix props w BBLs}

# ---------------------------------------------------------------------------------------------------
#ignore if you use file from drive - THIS IS HOW TO GET TO SHAPEFILE I READ IN BELOW (we can avoid using entire mappluto file now)

# #mappluto shapefile
# mappluto <- st_read("nyc_mappluto_24v3_1_fgdb/MapPLUTO24v3_1.gdb")
# 
# head(mappluto)
# 
# mappluto_clean <- mappluto %>%
#   select(Address, APPBBL)
# 
# #writing this to git for easier access - but it will be in drive and ignored on github
# st_write(mappluto_clean, "mappluto_bbl_address.geojson")
# ---------------------------------------------------------------------------------------------------

# mappluto <- st_read("mappluto_bbl_address.geojson") #from google drive /PLUTO

#nyu landlord properties (justfix)
justfix_nyu_props <- read.csv("nyuprops_who_owns_what_export.csv") #from github or drive /justfix

# Filter the BBL polygons based on your property BBLs
properties_sf_bbl <- mappluto[mappluto$APPBBL %in% justfix_nyu_props$bbl, ]

#write out shapefiles of these properties
# st_write(properties_sf_bbl, "nyuprops_bbl_address.geojson")


# View the result
plot(st_geometry(properties_sf_bbl), col = "purple")

```

```{r res hall props}
#mappluto shapefile

mappluto_clean <- read_sf("mappluto_bbl_address.geojson") %>%
  clean_names()

# Original address table
nyu_residence_halls <- data.frame(
  Building = c(
    "Brittany Hall", "Founders Hall", "Lipton Hall", "Res College at Paulson",
    "Rubin Hall", "Weinstein Hall", "Alumni Hall", "Broome Street",
    "Carlyle Court", "Coral Tower", "Gramercy Green", "Greenwich Hall",
    "Lafayette Hall", "Palladium Hall", "Second Street", "Seventh Street",
    "Sixth Street", "Third North", "University Hall"
  ),
  Address = c(
    "55 East 10th Street", "120 East 12th Street", "33 Washington Square",
    "181 Mercer Street", "35 Fifth Street", "5 University Place",
    "33 Third Avenue", "400 Broome Street", "25 Union Square West",
    "129 Third Avenue", "310 3rd Avenue", "636 Greenwich Street",
    "80 Lafayette Street", "140 East 14th Street", "1 East 2nd Street",
    "40 East Seventh Street", "200 East 6th St", "75 Third Avenue",
    "110 East 14th Street"
  )
)

# Add BBL and Add 2 columns
nyu_residence_halls <- nyu_residence_halls %>%
  mutate(
    BBL = c(
      56230, 55648, 55224, 52466, 4613, 5484, 4651, 4811, 84322, 8961,
      87943, 60346, 17220, 55922, 4589, 46218, 4616, 4671, 55912
    ),
    Add_2 = c(
      "787 BROADWAY", "120 EAST 12 STREET", "35 WASHINGTON SQ W", 
      "100 BLEECKER STREET", "25 COOPER SQUARE", "5 UNIVERSITY PLACE", 
      "31 3 AVENUE", "400 BROOME ST", "21 UNION SQUARE", "125 3 AVENUE", 
      "xxx", "636 GREENWICH STREET", "76 LAFAYETTE STREET", "126 EAST 14TH STREET", 
      "1 EAST 2 STREET", "38 E 7 STREET", "35 COOPER SQUARE", 
      "67 3 AVENUE", "106 EAST 14 STREET"
    )
  )

# Add the Manhattan borough code ("1") as a prefix to BBL
nyu_residence_halls <- nyu_residence_halls %>%
  mutate(
    BBL = paste0("1", sprintf("%09d", as.numeric(BBL))) # Ensure numeric BBL and pad to 9 digits
  )

# Normalize addresses in both datasets
nyu_residence_halls <- nyu_residence_halls %>%
  mutate(Add_2 = str_to_upper(Add_2)) %>%  # Convert to uppercase
  clean_names()

str(nyu_residence_halls$bbl)
str(mappluto_clean$bbl)

# mappluto_clean <- mappluto_clean %>%
#   mutate(address = str_trim(str_to_upper(address)))   


# View the updated dataset
print(nyu_residence_halls)

# # Geocode the addresses to get APPBBL (replace with real APPBBL values if known)
# geocoded_halls <- data.frame(
#   address = nyu_residence_halls$address,
#   APPBBL = c(
#     # Add APPBBL values manually or use a geocoding step here
#   )
# )

### troubleshooting addresses

# Look at some mappluto addresses
head(mappluto_clean)


# Filter the mappluto dataset
nyu_properties <- mappluto_clean %>%
  filter(address %in% nyu_residence_halls$add_2)

# Check the result
print(nyu_properties)

# Create the missing property as a data frame
missing_property <- data.frame(
  Building = "Gramercy Green",
  Address = "310 3rd Avenue",
  BBL = paste0("1", sprintf("%09d", 87943)), # Add "1" prefix and pad to 9 digits
  Add_2 = NA  # If no second address is available, leave it as NA
)

# Append the missing property to the existing data
nyu_properties <- bind_rows(nyu_properties, missing_property)

# View the updated properties list
print(nyu_properties)


# Optional: Save to a shapefile
st_write(nyu_properties, "nyu_residence_halls.shp")

```


```{r bbl props buffer}
#maybe unncessary if we can do this in QGIS but idk how

# Create a 100-foot buffer around the properties
buffer_100ft <- st_buffer(properties_sf_bbl, dist = 100) %>%
  st_transform(crs = st_crs(properties_sf_bbl))

# check crs
# st_crs(buffer_100ft)
# st_crs(properties_sf_bbl)

# Plot the result: Properties (purple points) and 100ft buffer (blue)
plot(st_geometry(buffer_100ft), border = "blue", main = "NYU Properties and 100ft Buffer")
plot(st_geometry(properties_sf_bbl), add = TRUE, col = "purple", pch = 16)
plot(st_geometry(calls_sf), add = TRUE, col = "lightblue", pch = 16)


```



```{r prop w COORDINATES via google API}
#Ignore since we're using bbls instead

# library(ggmap)
# register_google(key = "ADD KEY")

# #list of NYU buildings within neighborhood plan
# addresses <- data.frame(
#   address = c(
#     "35 West 4th Street, New York, NY",
#     "726 Broadway, New York, NY",
#     "708 Broadway, New York, NY",
#     "404 Lafayette, New York, NY",
#     "14 E 4th Street, New York, NY",
#     "383 Lafayette Street, New York, NY",
#     "411 Lafayette Street, New York, NY",
#     "20 Cooper Square, New York, NY"
#   )
# )
# ### COORDINATES w google API
# 
# # Convert to sf object (EPSG:4326 by default)
# coordinates <- addresses %>%
#   mutate_geocode(address, method = "google", latitude = "latitude", longitude = "longitude")
# 
# # Check coordinates returned by geocode
# print(coordinates)
# summary(coordinates$longitude)  # Should be around -74 for NYC
# summary(coordinates$latitude)   # Should be around 40.7 for NYC
# 
# # Step 3: Convert to sf object in EPSG:4326 (default from geocode)
# properties_sf <- st_as_sf(coordinates, coords = c("latitude", "longitude"), crs = 4326)
# 
# # # Step 4: Transform to EPSG:2263
# # properties_sf_2263 <- st_transform(properties_sf, crs = 2263)
# # 
# # # Check CRS
# # st_crs(properties_sf_2263)  # Should now be EPSG:2263

```


```{r properties with buffer}

# # Ensure CRS compatibility
st_crs(data_within_buffer)
summary(data_within_buffer$longitude)  # Should be around -74 for NYC
summary(data_within_buffer$latitude)   # Should be around 40.7 for NYC

st_crs(properties_sf_bbl)

calls_sf <- st_transform(data_within_buffer, crs = st_crs(properties_sf_bbl))

# # having crs issues :/ should probably figure this out in QGIS
# calls_and_props <- st_join(calls_sf, properties_sf_bbl)
# plot(st_geometry(calls_and_props))

# Create the heatmap
heatmap <- ggplot() +
  # Plot 311 Calls with transparency (alpha)
  geom_sf(data = calls_sf, aes(color = "Noise Complaints"), alpha = 0.5, size = 0.5) +
  
  # Plot Buffer layer with light blue semi-transparent fill and no outline
  geom_sf(data = buffer_100ft, fill = "100ft Buffer", color = NA, border = "blue", alpha = 0.5) +
  
  # Plot properties with purple outline and no fill (transparent)
  geom_sf(data = properties_sf_bbl, aes(color = "NYU Properties"), fill = NA, alpha = 1, size = 2) +
  
  # Customize theme and labels
  theme_minimal() +
  labs(title = "Noise Calls Heatmap",
       subtitle = "Within 1200ft of WSP, 100ft buffers around properties",
       color = NULL) +
  
  #Add a custom color palette for clarity
  scale_color_manual(values = c("Noise Complaints" = "red", "NYU Properties" = "purple", "100ft Buffer" = "lightblue"))


print(heatmap)

```



